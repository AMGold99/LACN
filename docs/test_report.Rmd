---
title: "General Report"
output: 
  html_document:
    css: "style.css"
    theme: flatly
    toc: true
    toc_float: true
    toc_depth: 3
params:
  plotfont: "Source Sans Pro"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# load packages
library(tidyverse)
library(showtext)
library(sysfonts)

# load fonts
font_add_google(params$plotfont)

showtext_auto()

# load LACN analysis environment
load("../lacn.RData")
```

#### 2020-21 LACN Operations Survey {#subtitle}

<hr/>


## Introduction


### Enrollment

<div class="row">

  <div class="col-sm-7">

```{r enroll-plot}
enroll_data |>
    ggplot(mapping = aes(reorder(`Institution Name`,enroll), enroll))+
    geom_hline(yintercept = c(0,1000,2000,3000,4000), 
               colour = 'grey')+
    geom_bar(stat="identity", fill = "#7CBCE8")+
  
#  geom_bar(data = subset(enroll_data, `Institution Name` == college),
#           stat = 'identity', fill = "#217DBB") +
#  ggrepel::geom_text_repel(
#    data = subset(
#      enroll_data,
#      `Institution Name` == college
#    ),
#    aes(
#      label=`Institution Name`
#    ),
#    nudge_y=500,
#    color = "black",
#    size = 5
#  )+
  
    labs(
      title = NULL,
      x = NULL,
      y = "Total"
    )+
    theme(
      axis.text.x = element_blank(),
      axis.ticks = element_blank(),
      panel.background = element_blank(),
      plot.margin = unit(c(1,1,1,1), "cm"),
      text = element_text(size = 45, family = params$plotfont)
    )
```

  </div>

  <div class="col-sm-5">

```{r enroll-table}
tableViz(enroll_data, var = "enroll")
```

  </div>

</div>


### Endowment

<div class="row">

  <div class="col-sm-7">

```{r endow-plot}

endow_data |>
    ggplot(mapping = aes(reorder(`Institution Name`,endow_bil), endow_bil))+
    geom_hline(yintercept = c(0,1,2,3), colour = "grey")+
    geom_bar(stat="identity", fill = "#7CBCE8")+
    labs(
      title = NULL,
      x = NULL,
      y = "Total (in billions)"
    )+ 
  #geom_bar(data = subset(endow_data, `Institution Name` == college),
  #         stat = 'identity', fill = "#217DBB") +
  #geom_label(data = subset(endow_data, `Institution Name` == college), 
  #           aes(label = `Institution Name`))+
    theme(
      axis.text.x = element_blank(),
      axis.ticks = element_blank(),
      panel.background = element_blank(),
      text = element_text(size = 45, family = params$plotfont)
      )
```

  </div>

  <div class="col-sm-5">

```{r endow-table}
tableViz(endow_data, var = "endow")
```

  </div>

</div>

<hr/>


## Reporting and Staffing

<div class="row">

### Reporting Structure

  <div class="col-sm-7">

```{r reporting-plot}

singlePlot(reporting_data, q = "Q2",
           string_rem = ":",
           size = 45,
           font = params$plotfont)

```

  </div>


  <div class="col-sm-5">

`r nTab(question_list$Q2['Institution Name'])`

  </div>

</div>

<div class="row">

### Steps Removed from President's Office

  <div class="col-sm-7">

```{r steps-plot}

  singlePlot(steps_data, q = "Q3",
           string_rem = "[:blank:]\\(.+\\)",
           size = 45,
           font = params$plotfont)

```

  </div>

<div class="col-sm-5">

`r nTab(question_list$Q3['Institution Name'])`

  </div>

</div>

### Student Staff (total)

<div class="row">

  <div class="col-sm-7">

```{r student-staff-plot}

matrixPlot(student_staff_data, breaks = c(0,25,50,75,100),
           font = params$plotfont,
           size = 45)

```

  </div>


  <div class="col-sm-5">

```{r student-staff-table}

tableViz(data = student_staff_data,'n')

```

  </div>

</div>

### Professional (FTE)

<div class="row">

  <div class="col-sm-7">

```{r prof-plot}
matrixPlot(prof_staff_data, breaks = c(0,10,20,30),
           font = params$plotfont,
           size = 45)
```

  </div>
  
  <div class="col-sm-5">

```{r prof-table}
tableViz(prof_staff_data, var = 'n')
```
  
  </div>
  
</div>

### Student to Professional Staff (FTE) Ratio

<div class="row">

  <div class="col-sm-7">

```{r sp-ratio-plot}

matrixPlot(student_prof_ratio, breaks = c(0,100,200,300,400,500),
           font = params$plotfont,
           size = 45)

```

  </div>
  
  <div class="col-sm-5">

```{r sp-ratio-table}

tableViz(student_prof_ratio, var='n')

```

  </div>
  
</div>

### Professional Staff: Advising

<div class="row">

  <div class="col-sm-7">

```{r prof-advising-plot}
matrixPlot(prof_advising_data, breaks = c(0,50,100,150,200), 
           font = params$plotfont,
           size = 45)
```

  </div>
  
  <div class="col-sm-5">

```{r prof-advising-table}
tableViz(prof_advising_data, 'n')
```
  
  </div>

</div>

### Professional Staff: Employer Relations

<div class="row">

  <div class="col-sm-7">

```{r prof-employer-plot}
matrixPlot(prof_employer_data,
           breaks = c(0,25,50,75,100), 
           font = params$plotfont, 
           size = 45)
```

  </div>
  
  <div class="col-sm-5">

```{r prof-employer-table}
tableViz(prof_employer_data, 'n')
```

  </div>
  
</div>

<hr/>


## Student/Alum Engagement

### Student Engagement by Class Year

<div class="row">

  <div class="col-sm-7">

```{r sengage-year-plot}

sengage_year_data |>
  ggplot2::ggplot(ggplot2::aes(dim1,engage))+
  
  ggplot2::geom_hline(yintercept = c(0,25,50,75,100), colour = "grey")+
  ggplot2::geom_bar(ggplot2::aes(fill = measure),
                    position = "dodge",
                    stat = "identity")+
  ggplot2::scale_y_continuous(limits = c(0,100), breaks = c(0,25,50,75,100))+
  ggplot2::labs(
    y = "Engagement (%)",
    x = NULL
  )+
  ggplot2::scale_fill_manual(
    values=c(Max = "#76828E", 
             Mean = "#6AD4BF",
             Median = "#F7BF66"
             #, `Your School` = "#217DBB"
             )
    )+
  ggplot2::theme(
    text = ggplot2::element_text(size = 45, family = params$plotfont),
    axis.ticks = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_text(size = 30, lineheight = 0.5),
    panel.background = ggplot2::element_blank(),
    legend.title = ggplot2::element_blank(),
    legend.position = "top"
    )
```

  </div>
  
  <div class="col-sm-5">
  
<!-- Q for Nate: what do we consider a missing value here? I'm only
considering whether they answered total engagement for "TOTAL (all classes)"--> 

`r nTab(question_list$Q21$Q21_5_4)`

\n \n Note: Engagement \n includes appointments \n w/ professional staff \n and peer advisors and \n programs and events

  </div>
  
</div>

### Student Engagement by Type of Engagement

<div class="row">

  <div class="col-sm-7">

```{r sengage-type-plot}
sengage_type_data |>

  dplyr::select(!c(main:sub2,Question))  |>
  dplyr::mutate(across(`Undergraduate enrollment`:engage, as.numeric)) |>
  
  dplyr::group_by(dim2) |>
  dplyr::summarise(Mean = mean(engage, na.rm = TRUE), 
                   Median = median(engage, na.rm = TRUE),
                   Max = max(engage, na.rm = TRUE),
                   #`Your School` = mean(engage[`Institution Name`== params$college], na.rm = TRUE)
  ) |>
  tidyr::pivot_longer(
    cols = !dim2,
    names_to = "measure",
    values_to = "engage"
  ) |>
  
  ggplot2::ggplot(ggplot2::aes(dim2,engage))+
  
  ggplot2::geom_hline(yintercept = c(0,25,50,75,100), colour = "grey")+
  ggplot2::geom_bar(ggplot2::aes(fill = measure),
                    position = "dodge",
                    stat = "identity")+
  ggplot2::scale_y_continuous(limits = c(0,100), breaks = c(0,25,50,75,100))+
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 15))+
  ggplot2::labs(
    y = "Engagement (%)",
    x = NULL
  )+
  ggplot2::scale_fill_manual(
    values=c(Max = "#76828E", 
             Mean = "#6AD4BF",
             Median = "#F7BF66"
             #, `Your School` = "#217DBB"
    )
  )+
  ggplot2::theme(
    text = ggplot2::element_text(size = 45, family = params$plotfont,
                                 lineheight = .5),
    axis.ticks = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_text(size = 30),
    panel.background = ggplot2::element_blank(),
    legend.title = ggplot2::element_blank(),
    legend.position = "top"
  )
```

  </div>
  
  <div class="col-sm-5">

```{r sengage-type-table}
plot(cars)
```

  </div>
  
</div>

### Professional Staff Appt w/ Students (by class year) (distribution)

<div class="row">

  <div class="col-sm-7">

```{r appt-student-dist-plot}
appt_student_data |>
  
  ggplot2::ggplot(ggplot2::aes(reorder(`Institution Name`, Appt) ,Appt))+
  ggplot2::geom_hline(yintercept = c(0,2000,4000,6000), colour = "grey")+
  ggplot2::geom_bar(ggplot2::aes(fill = Year),
                    position = "stack",
                    stat = "identity") +
#  ggrepel::geom_text_repel(data = subset(appt_student_data,
#                                          `Institution Name` == params$college & Year == "Sophomore"),
#                            mapping = ggplot2::aes(label = `Institution Name`),
#                            min.segment.length = 0,
#                            hjust = -10)+
  ggplot2::scale_y_continuous(breaks = c(0,2000,4000,6000)) +
  ggplot2::labs(
    y = "Total",
    x = NULL)+
  ggplot2::scale_fill_manual(
    values=c(`First-Year` = "#76828E",
             Sophomore = "grey",
             Junior = "#6AD4BF",
             Senior = "#F7BF66"))+
  ggplot2::theme(
    text = ggplot2::element_text(size = 45, 
                                 family = params$plotfont),
    axis.text.x = ggplot2::element_blank(),
    axis.ticks = ggplot2::element_blank(),
    panel.background = ggplot2::element_blank(),
    legend.title = ggplot2::element_blank(),
    legend.text = ggplot2::element_text(size = 30),
    legend.position = "right"
    )

```

  </div>
  
  <div class="col-sm-5">

```{r appt-student-dist-table}


tableViz(
  data = appt_student_data |>
    dplyr::group_by(`Institution Name`) |>
    dplyr::summarise(Appt = sum(Appt)),
  
  var = "Appt"
)
```

  </div>
  
</div>

### Professional Staff Appt w/ Students (by class year) (grouped bar)

<div class="row">

  <div class="col-sm-7">

```{r appt-student-group-plot}
plot(cars)
```

  </div>
  
  <div class="col-sm-5">

```{r appt-student-group-table}
plot(cars)
```

  </div>
  
</div>

### Professional Staff Appt w/ Alum

<div class="row">

  <div class="col-sm-7">

```{r appt-alum-plot}
appt_alum_data |>
  ggplot2::ggplot(ggplot2::aes(reorder(`Institution Name`, engage), engage))+
  ggplot2::geom_hline(yintercept = c(0,500,1000,1500), colour = "grey")+
  ggplot2::geom_bar(ggplot2::aes(fill = dim2),
                    position = "stack",
                    stat = "identity")+
  ggplot2::labs(
    y = "Total",
    x = NULL,
    caption = "*In-Person, Phone, or Video Chat"
  )+
  ggplot2::scale_fill_manual(
    values = c(
      `Appointments*` = "#F7BF66",
      `Email Consultations` = "#6AD4BF"
    )
  )+
  ggplot2::theme(
    text = ggplot2::element_text(size = 45, family = params$plotfont),
    axis.text.x = ggplot2::element_blank(),
    axis.ticks = ggplot2::element_blank(),
    panel.background = ggplot2::element_blank(),
    legend.title = ggplot2::element_blank(),
    legend.position = "top"
  )
```

  </div>
  
  <div class="col-sm-5">

```{r appt-alum-table}
tableViz(
  data = appt_alum_data |>
    dplyr::group_by(`Institution Name`) |>
    dplyr::summarise(engage = sum(engage)),
  
  var = "engage", 
  na.rm = TRUE
  )
```

  </div>
  
</div>

### Professional Staff Appt (+ email) per Total FTE

<div class="row">

  <div class="col-sm-7">

```{r appt-fte-plot}
appt_fte_data |>
  ggplot2::ggplot(ggplot2::aes(reorder(`Institution Name`,ratio),ratio))+
  ggplot2::geom_hline(yintercept = c(0,500,1000,1500), colour = "grey")+
  ggplot2::geom_bar(stat = "identity", fill = "#7CBCE8")+
  
  ggplot2::labs(
    x = NULL,
    y = "Appt. to FTE Ratio",
    caption = "Note: includes only institutions that\n reported both appointments and FTE"
  )+
  
  ggplot2::theme(
    text = ggplot2::element_text(size = 45, family = params$plotfont,
                                 lineheight = .5),
    panel.background = ggplot2::element_blank(),
    axis.ticks = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_blank()
  )
```

  </div>
  
  <div class="col-sm-5">

```{r appt-fte-table}
tableViz(appt_fte_data, var = "ratio", na.rm = TRUE)
```
  </div>
  
</div>

### Experiential Learning Participation

<div class="row">

  <div class="col-sm-7">

```{r exper-learning-plot}
exper_learning_data |>
  
  dplyr::mutate(dim1 = stringr::str_replace(dim1,
                                           "Internship.+research\\)",
                                           "Internship**")) |>
  dplyr::group_by(dim1) |>
  dplyr::summarise(Mean = mean(exper, na.rm = TRUE), 
                   Median = median(exper, na.rm = TRUE),
                   Max = max(exper, na.rm = TRUE)
                   #, `Your School` = mean(exper[`Institution Name`==params$college])
  ) |>
  
  tidyr::pivot_longer(
    cols = !dim1,
    names_to = "measure",
    values_to = "exper"
  ) |>
  ggplot2::ggplot(ggplot2::aes(reorder(dim1,-exper),exper))+
  
  ggplot2::geom_hline(yintercept = c(0,25,50,75,100), colour = "grey")+
  ggplot2::geom_bar(ggplot2::aes(fill = measure),
                    stat = "identity",
                    position = "dodge")+
  ggplot2::scale_x_discrete(
    labels = function(x) stringr::str_wrap(x, width = 12)
    )+
  ggplot2::labs(
    x = NULL,
    y = "% of Students",
    caption = "*Internship, pre-licensure field experience, mentored experience or similar professional experience\n **Including pre-licensure field experience, NOT including mentored undergraduate research"
  )+
  ggplot2::scale_fill_manual(
    values=c(Max = "#76828E", 
             Mean = "#6AD4BF",
             Median = "#F7BF66"
             #, `Your School` = "#217DBB"
    )
  )+
  ggplot2::theme(
    plot.caption = ggplot2::element_text(size = 20, 
                                         margin = ggplot2::margin(t = "10")),
    text = ggplot2::element_text(size = 45, family = params$plotfont,
                                 lineheight = .5),
    axis.text.x = ggplot2::element_text(size = 25),
    panel.background = ggplot2::element_blank(),
    axis.ticks = ggplot2::element_blank(),
    legend.position = "top",
    legend.title = ggplot2::element_blank()
  )

```

  </div>
  
  <div class="col-sm-5">

```{r exper-learning-table}
exper_learning_data |>
  tidyr::pivot_wider(
    names_from = dim1,
    values_from = exper
  ) |>
  
  tableViz(var = "Any Experiential Learning*",subtitle = "Any Experiential Learning Only",na.rm = TRUE)
```

  </div>
  
</div>

<hr/>

## Budget

### Total Available Funding

<div class="row">

  <div class="col-sm-7">
```{r}
funding_data |>
  ggplot2::ggplot(ggplot2::aes(reorder(`Institution Name`,total_mil),
                               total_mil, fill = dim1))+
  ggplot2::geom_hline(yintercept = c(0,2,4,6), colour = "grey")+
  ggplot2::geom_bar(stat = "identity", position = "stack")+
  ggplot2::labs(
    x = NULL,
    y = "Total (in millions)"
  )+
  ggplot2::scale_fill_manual(
    values=c(`Endowed Funds` = "#6AD4BF",
             `Expendable Gifts` = "grey",
             Other = "#F7BF66"
             #, `Your School` = "#217DBB"
    )
  )+
  ggplot2::theme(
    text = ggplot2::element_text(size = 35, family = params$plotfont,
                                 lineheight = .5),
    panel.background = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_blank(),
    axis.ticks = ggplot2::element_blank(),
    legend.title = ggplot2::element_blank()
  )

```

  </div>
  
  <div class="col-sm-5">

```{r total-funding-table}

tableViz(
  data = funding_data |>
    dplyr::group_by(`Institution Name`) |>
    dplyr::summarise(total = sum(total)),
  
  var = 'total'
)

```

  </div>
  
</div>

### Endowed Funds

<div class="row">

  <div class="col-sm-7">

```{r endow-fund-plot}
endow_exp_data |>
  ggplot2::ggplot(ggplot2::aes(reorder(`Institution Name`, amount_mil), amount_mil, fill = dim2))+
  ggplot2::geom_hline(yintercept = c(0,0.5,1,1.5,2), colour = "grey")+
  ggplot2::geom_bar(stat = "identity", position = "stack") +
  ggplot2::labs(
    y = "Total (in millions)",
    x = NULL
  )+
  
  ggplot2::scale_y_continuous(labels = c("0","0.5","1","1.5","$2"))+
  
  ggplot2::scale_fill_manual(
    values = c(
      `Funded Internships` = "#6AD4BF",
      Other = "#F7BF66"
    )
  )+
  
  ggplot2::theme(
    text = ggplot2::element_text(family = params$plotfont, size = 35),
    panel.background = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_blank(),
    axis.ticks = ggplot2::element_blank(),
    legend.title = ggplot2::element_blank(),
    legend.text = ggplot2::element_text(size = 30)
  )
```

  </div>
  
  <div class="col-sm-5">

```{r endow-fund-table}
tableViz(data = endow_exp_data |>
           dplyr::group_by(`Institution Name`) |>
           dplyr::summarise(amount = sum(amount)), 
         
         var = 'amount')
```

  </div>
  
</div>

### Expendable Gifts

<div class="row">

  <div class="col-sm-7">

```{r expend-gift-plot}
gift_data |>
  ggplot2::ggplot(ggplot2::aes(reorder(`Institution Name`, amount_thou), amount_thou, fill = dim2))+
  ggplot2::geom_hline(yintercept = c(0,250,500,750,1000), colour = "grey")+
  ggplot2::geom_bar(stat = "identity", position = "stack")+
  ggplot2::labs(
    y = "Total (in thousands)",
    x = NULL
  )+
  
  ggplot2::scale_y_continuous(labels = c("0","250","500","750","$1000"))+
  
  ggplot2::scale_fill_manual(
    values = c(
      `Funded Internships` = "#6AD4BF",
      Other = "#F7BF66"
    )
  )+
  
  ggplot2::theme(
    text = ggplot2::element_text(family = params$plotfont, size = 35),
    panel.background = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_blank(),
    axis.ticks = ggplot2::element_blank(),
    legend.title = ggplot2::element_blank(),
    legend.text = ggplot2::element_text(size = 3)
  )
```

  </div>
  
  <div class="col-sm-5">

```{r expend-gift-table}
gift_data |>
  dplyr::group_by(`Institution Name`) |>
  dplyr::summarise(amount = sum(amount)) |>
  dplyr::filter(!is.na(amount) & amount > 0) |>
  tableViz(var = "amount")
```

  </div>
  
</div>

<hr/>


Special thanks to **ACKNOWLEDGEMENTS HERE**


